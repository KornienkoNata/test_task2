Процедура ОбработкаПроведения(Отказ, Режим)
	 	 
	// регистр ОстаткиНоменклатуры Расход
	Движения.ОстаткиНоменклатуры.Записывать = Истина;
	
	Для Каждого ТекСтрокаСписокНоменклатуры Из СписокНоменклатуры Цикл
		Движение = Движения.ОстаткиНоменклатуры.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
		Движение.Период = Дата;
		Движение.Номенклатура = ТекСтрокаСписокНоменклатуры.Номенклатура;
		Движение.Склад = Склад;
		Движение.Количество = ТекСтрокаСписокНоменклатуры.Количество;
	КонецЦикла;

	Движения.Записать();	
	//Констроль остатков
	    
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ОстаткиНоменклатурыОстатки.КоличествоОстаток КАК Количество,
		|	ОстаткиНоменклатурыОстатки.Номенклатура,
		|	ОстаткиНоменклатурыОстатки.Склад
		|ИЗ
		|	РегистрНакопления.ОстаткиНоменклатуры.Остатки(
		|			,
		|			Склад = &Склад
		|				И Номенклатура В
		|					(ВЫБРАТЬ
		|						РасходнаяНакладнаяСписокНоменклатуры.Номенклатура
		|					ИЗ
		|						Документ.РасходнаяНакладная.СписокНоменклатуры КАК РасходнаяНакладнаяСписокНоменклатуры
		|					ГДЕ
		|						РасходнаяНакладнаяСписокНоменклатуры.Ссылка = &Ссылка)) КАК ОстаткиНоменклатурыОстатки
		|ГДЕ
		|	ОстаткиНоменклатурыОстатки.КоличествоОстаток < 0";
	
	Запрос.УстановитьПараметр("Склад", Склад);
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	Если НЕ РезультатЗапроса.Пустой() Тогда
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			Сообщить("Недостаточно товара "+ ВыборкаДетальныеЗаписи.Номенклатура + " в количестве " + ВыборкаДетальныеЗаписи.Количество + " на складе "+ ВыборкаДетальныеЗаписи.Склад);
		КонецЦикла;
		Отказ = Истина;
		Возврат;
	КонецЕсли;

	//Расчет себестоимости
	Движения.СебестоимостьТоваров.Записывать = Истина;	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СебестоимостьТоваровОстатки.Номенклатура,
		|	СебестоимостьТоваровОстатки.СуммаОстаток КАК Сумма,
		|	СебестоимостьТоваровОстатки.КоличествоОстаток КАК Количество
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Остатки(
		|			&МоментВремени,
		|			Номенклатура В
		|				(ВЫБРАТЬ
		|					РасходнаяНакладнаяСписокНоменклатуры.Номенклатура
		|				ИЗ
		|					Документ.РасходнаяНакладная.СписокНоменклатуры КАК РасходнаяНакладнаяСписокНоменклатуры
		|				ГДЕ
		|					РасходнаяНакладнаяСписокНоменклатуры.Ссылка = &Ссылка)) КАК СебестоимостьТоваровОстатки";
	
	Запрос.УстановитьПараметр("МоментВремени", МоментВремени());
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	// регистр Продажи 
	Движения.Продажи.Записывать = Истина;
	
	// регистр РегистрБухУет 
	Движения.РегистрБухУчет.Записывать = Истина;
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Если ВыборкаДетальныеЗаписи.Количество<>0 Тогда
			СебестоимостьЕденицы = ВыборкаДетальныеЗаписи.Сумма/ВыборкаДетальныеЗаписи.Количество;
		Иначе
			СебестоимостьЕденицы = 0;
		КонецЕсли;
		
		Движение = Движения.СебестоимостьТоваров.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
		Движение.Период = Дата;		
		Движение.Номенклатура = ВыборкаДетальныеЗаписи.Номенклатура;		
		СтрокаТЧ = СписокНоменклатуры.Найти(ВыборкаДетальныеЗаписи.Номенклатура, "Номенклатура");
		Движение.Количество = СтрокаТЧ.Количество;
		Движение.Сумма = СебестоимостьЕденицы* СтрокаТЧ.Количество;
		
		//Регистр бухалтерии
		Движение = Движения.РегистрБухУчет.Добавить();
		//Дт ПрибылиУбытки Кт Товары 
		Движение.СчетДт = ПланыСчетов.Управленческий.ПрибылиУбытки;
		Движение.СчетКт = ПланыСчетов.Управленческий.Товары;
		Движение.Период = Дата;		
		
		Движение.Сумма =СебестоимостьЕденицы* СтрокаТЧ.Количество ;
		Движение.КоличествоКт= ВыборкаДетальныеЗаписи.Количество;
		Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконто.Склад] = Склад;
				
		Движение = Движения.РегистрБухУчет.Добавить();
		//Дт Покупатели Кт Прибыли Убытки
		Движение.СчетДт =	 ПланыСчетов.Управленческий.Покупатели;
		Движение.СчетКт = ПланыСчетов.Управленческий.ПрибылиУбытки;
		Движение.Период = Дата;
		Движение.Сумма = СуммаДокумента;		
		Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Номенклатура] =ВыборкаДетальныеЗаписи.Номенклатура;;
		
		Движение = Движения.Продажи.Добавить();
		Движение.Период = Дата;
		Движение.Номенклатура = ВыборкаДетальныеЗаписи.Номенклатура;
		Движение.Цена = СтрокаТЧ.Цена*СтрокаТЧ.Количество;
		Движение.Количество = СтрокаТЧ.Количество;
		Движение.Себестоимость = СебестоимостьЕденицы* СтрокаТЧ.Количество;
	КонецЦикла;
		 
	
КонецПроцедуры

	
